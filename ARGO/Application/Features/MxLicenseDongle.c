/////////////////////////////////////////////////////////////////////////////
//
//   MMM     MMM       AAA       TTTTTTTTTT  RRRRRR    IIIIIIII  XX   XX
//   MMMM   MMMM      AA AA          TT      RR   RR      II      XX XX
//   MM MM MM MM     AA   AA         TT      RR    RR     II       XXX
//   MM  MM   MM    AAAAAAAAA        TT      RRRRRRR      II       XXX
//   MM       MM   AA       AA       TT      RR  RR       II      XX XX
//   MM       MM  AA         AA      TT      RR   RR   IIIIIIII  XX   XX
//
//   Company      : Matrix Telecom Pvt. Ltd., Baroda, India.
//   Project      : Access control System
//   Created By   : Manish chandra
//   File         : MxLicenseDongle.c
//   Description  : This file handles all activity related to License Dongle feature.
//
/////////////////////////////////////////////////////////////////////////////
#define _GNU_SOURCE

//******** Place all include files ***
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <errno.h>
#include <signal.h>
#include <unistd.h>
#include <pthread.h>
#include <openssl/rand.h>
#include <openssl/aes.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <netinet/in.h>
#include <sys/time.h>
#include <netdb.h>
#include <sys/ioctl.h>
#include <net/if.h>
#include <sys/stat.h>
#include <curl/curl.h>

#include "MxSysCommonDef.h"
#include "MxAcmsCommon.h"
#include "MxLogs.h"
#include "MxAcmsSocket.h"
#include "MxConfig.h"
#include "MxLicenseDongle.h"
#include "MxTypedef.h"
#include "MxSysTimer.h"
#include "MxAcmsTask.h"
#include "MxSysUtils.h"
#include "MxSysUtils.h"
#include "MxSysCommonUtils.h"
#include "MxConfigFileIo.h"
#include "AesCbcCrypto.h"

//******** Extern Variables **********
extern ETHERNET_PARA_t		  	EthernetParameters;
extern LICENSE_DONGLE_CONFIG_t 	LicenseDongleCfg;
extern BOOL						LicenseDongleConnted;
extern BOOL						LicenseDongleConntedPrevState;
extern BOOL 					licenseServerParaChangeF;
extern BOOL						DongleInsertedF;

//******** Defines and Data Types ****
#define BYTE_SCREMBALING_FWD			0
#define BYTE_SCREMBALING_BKWD			1
#define MAX_SCRAMBLING_METHOD			32
#define MAX_SERVICE_PROFILE_LEN			12
#define MAX_MD5_DIGEST_LEN				16
#define BITS_PER_BYTE					8
#define AES_256_KEY_SIZE_IN_BITS		256

typedef enum
{
	LICENSE_DONGLE_SEND_LICENSE_CHK_REQ,
	LICENSE_DONGLE_ACK_LICENSE_CHK,
	LICENSE_DONGLE_GET_LICENSE_KEY_REQ,
	LICENSE_DONGLE_GET_LICENSE_KEY_ACK,
	LICENSE_DONGLE_READ_LICENSE_KEY_REQ,
	LICENSE_DONGLE_READ_LICENSE_KEY_ACK,
	LICENSE_DONGLE_SEND_MSG_WAIT_STATE,
	LICENSE_DONGLE_SEND_RECV_MSG_WAIT_STATE,
	LICENSE_DONGLE_POLL_INTERVAL_STATE,
	MAX_LICENSE_DONGLE_SEND_RECV_MSG_STATE
}LICENSE_DONGLE_STATE_e;


typedef enum
{
	LICENSE_DONGLE_RESPONSE_CODE_SUCCESS,
	LICENSE_DONGLE_RESPONSE_CODE_FAIL,
	LICENSE_DONGLE_RESPONSE_CODE_WRITE_KEY,
	LICENSE_DONGLE_RESPONSE_CODE_READ_KEY,
	MAX_LICENSE_DONGLE_RESPONSE_CODE
}LICENSE_DONGLE_RESPONSE_CODE_e;

#define GEN_LICENSE_DONGLE_ENUM(LICENSE_DONGLE_ENUM, LICENSE_DONGLE_NAME)	LICENSE_DONGLE_ENUM,
#define GEN_LICENSE_DONGLE_NAME(LICENSE_DONGLE_ENUM, LICENSE_DONGLE_NAME)	LICENSE_DONGLE_NAME,

#define LICENSE_DONGLE_SND_MSG_HDR(API)\
		API(REQ_LICNSE_KEY,		"REQ_LCK")\
		API(GET_LICNSE_KEY,		"GET_LKY")\
		API(REQ_READ_KEY,		"SET_LKY")\
		API(ACK_LICNSE_KEY,		"ACK_LCK")\
		API(ACK_GET_LICNSE_KEY,	"ACK_GKY")\
		API(ACK_READ_KEY,		"ACK_SKY")\

typedef enum
{
	LICENSE_DONGLE_SND_MSG_HDR(GEN_LICENSE_DONGLE_ENUM)
	MAX_LICENSE_DONGLE_SND_MSG_HDR,
}SND_LICENSE_DONGLE_MSG_HDR_e;

typedef struct
{
	UINT8 methodByte;
	UINT8 methodBit;
}METHOD_PARAM_t;

typedef struct
{
	METHOD_PARAM_t methodPara[MAX_SERVICE_PROFILE_LEN][BITS_PER_BYTE];

}SCRAMBLE_METHOD_t;
//******** Global Variables **********

UINT16								LicensePollDuration, LastServerRandom;
BOOL 								ReadStatus;
ACMS_COMM_STATUS_e					LicenseServerConnctnStatus = ACMS_OFFLINE;
UINT8								LockCount = 0;
UINT8								stopConnectionCount=0;	//stop connection count after dongle removed

//******** Static Variables **********
static UINT16						licensePollInterval;
static UINT16						lastRandBytes;
static UINT32						licenseDongleMsgTimerTick;
static UINT32						licenseDongleMsgWaitTime;

static LICENSE_DONGLE_STATE_e		licenseDongleMsgState;
static LICENSE_DONGLE_STATE_e		licenseDongleNxtMsgState;
static LICENSE_DONGLE_STATE_e		licenseDongleNxtMsgSuccessState;

static LICENSE_DONGLE_RESPONSE_CODE_e	licenseDnglRspCode;

static CHARPTR licenseDongleSendMsgHdr[MAX_LICENSE_DONGLE_SND_MSG_HDR] =
{
	LICENSE_DONGLE_SND_MSG_HDR(GEN_LICENSE_DONGLE_NAME)
};

static THREAD_STATUS_e		resolveLicenceDongleThreadStatus = THREAD_INACTIVE;
static pthread_t			resolveLicenceDongleThreadId = 0;
static int					resolveLicenceDongleStatus = 0;
static pthread_mutex_t		licenceDongleIpResolveMutex = PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP;
static struct in_addr		resolvedIpSinAddr;
static const SCRAMBLE_METHOD_t scramblingMethod[MAX_SCRAMBLING_METHOD] =
{
	// Method 0
	{
		{
			{
				{8,5}, {7,5}, {6,5}, {4,5}, {5,5}, {3,5}, {3,2}, {4,2}
			},

			{
				{0,5}, {2,5}, {1,5}, {6,7}, {7,7}, {5,7}, {4,7}, {3,7}
			},

			{
				{2,7}, {1,7}, {11,2}, {9,2}, {10,2}, {8,2}, {7,2}, {6,2}
			},

			{
				{1,3}, {0,3}, {11,1}, {10,1}, {9,1}, {0,2}, {11,3}, {10,3}
			},

			{
				{9,3}, {8,3}, {7,3}, {3,3}, {6,3}, {4,3}, {8,7}, {2,3}
			},

			{
				{5,0}, {5,1}, {5,2}, {5,3}, {5,4}, {8,1}, {7,1}, {6,1}
			},

			{
				{3,1}, {4,1}, {0,7}, {2,1}, {1,1}, {0,1}, {11,6}, {10,6}
			},

			{
				{7,6}, {9,6}, {9,7}, {6,6}, {5,6}, {4,6}, {3,6}, {2,6}
			},

			{
				{1,6}, {11,4}, {10,4}, {8,4}, {9,4}, {10,7}, {8,6}, {1,2}
			},

			{
				{7,4}, {6,4}, {3,4}, {11,7}, {4,4}, {2,4}, {1,4}, {0,4}
			},

			{
				{11,5}, {10,5}, {9,5}, {10,0}, {11,0}, {9,0}, {8,0}, {0,0}
			},

			{
				{7,0}, {6,0}, {3,0}, {0,6}, {4,0}, {2,0}, {1,0}, {2,2}
			}
		},
	},
	// Method 1
	{
		{
			{
				{10,6}, {10,5}, {10,4}, {10,2}, {10,3}, {10,1}, {1,5}, {1,4}
			},

			{
				{10,0}, {0,5}, {0,4}, {0,2}, {0,3}, {0,1}, {0,0}, {11,6}
			},

			{
				{11,5}, {11,4}, {11,3}, {11,1}, {11,2}, {11,0}, {1,7}, {1,6}
			},

			{
				{3,5}, {11,7}, {8,7}, {8,6}, {0,7}, {1,0}, {2,7}, {2,6}
			},

			{
				{2,5}, {2,4}, {2,3}, {2,1}, {2,2}, {2,0}, {3,7}, {3,6}
			},

			{
				{5,0}, {5,1}, {5,2}, {5,3}, {5,4}, {0,6}, {4,7}, {4,6}
			},

			{
				{4,5}, {4,4}, {4,3}, {4,2}, {4,1}, {4,0}, {9,7}, {9,6}
			},

			{
				{5,7}, {5,6}, {5,5}, {3,4}, {3,3}, {3,2}, {3,1}, {3,0}
			},

			{
				{10,7}, {9,5}, {9,4}, {9,2}, {9,3}, {9,1}, {1,3}, {1,1}
			},

			{
				{9,0}, {6,7}, {6,6}, {6,4}, {6,5}, {6,3}, {6,2}, {6,1}
			},

			{
				{6,0}, {8,5}, {8,4}, {8,2}, {8,3}, {8,1}, {8,0}, {7,0}
			},

			{
				{7,7}, {7,6}, {7,5}, {7,3}, {7,4}, {7,2}, {7,1}, {1,2}
			}
		},
	},

	//m-2
	{
		{
			{
				{00, 4}, {00, 5}, {00, 2}, {00, 0}, {00, 3}, {00, 1}, {03, 7}, {03, 6}
			},
			{
				{01, 7}, {01, 6}, {01, 5}, {01, 3}, {01, 4}, {01, 2}, {01, 1}, {01, 0}
			},
			{
				{02, 7}, {02, 6}, {02, 5}, {02, 0}, {02, 4}, {02, 1}, {02, 2}, {02, 3}
			},
			{
				{05, 7}, {05, 6}, {05, 5}, {03, 4}, {03, 3}, {8, 6}, {00, 7}, {00, 6}
			},
			{
				{04, 7}, {04, 6}, {04, 5}, {04, 3}, {04, 4}, {04, 2}, {04, 1}, {04, 0}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {03, 2}, {03, 1}, {03, 0}
			},
			{
				{10, 7}, {9, 6}, {11, 6}, {11, 5}, {11, 4}, {11, 3}, {11, 2}, {11, 1}
			},
			{
				{11, 0}, {10, 6}, {10, 5}, {10, 4}, {10, 3}, {10, 2}, {10, 1}, {10, 0}
			},
			{
				{9, 7}, {06, 7}, {06, 6}, {06, 4}, {06, 5}, {06, 3}, {03, 5}, {8, 7}
			},
			{
				{06, 2}, {06, 1}, {06, 0}, {07, 6}, {07, 7}, {07, 5}, {07, 4}, {07, 3}
			},
			{
				{07, 2}, {07, 1}, {07, 0}, {9, 3}, {9, 4}, {9, 5}, {9, 2}, {8, 4}
			},
			{
				{9, 0}, {9, 1}, {8, 1}, {8, 3}, {8, 0}, {8, 2}, {8, 5}, {11, 7}
			}
		},
	},

//m-3
	{
		{
			{
				{11, 0}, {10, 0}, {9, 0}, {07, 0}, {8, 0}, {06, 0}, {01, 5}, {00, 5}
			},
			{
				{03, 0}, {04, 0}, {00, 6}, {01, 0}, {02, 0}, {00, 0}, {11, 5}, {10, 5}
			},
			{
				{9, 5}, {8, 5}, {07, 5}, {05, 5}, {06, 5}, {04, 5}, {03, 5}, {02, 5}
			},
			{
				{04, 2}, {8, 6}, {02, 2}, {01, 2}, {00, 2}, {04, 7}, {03, 7}, {02, 7}
			},
			{
				{01, 7}, {11, 2}, {10, 2}, {8, 2}, {9, 2}, {07, 2}, {06, 2}, {03, 2}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {11, 3}, {10, 3}, {9, 3}
			},
			{
				{8, 3}, {07, 3}, {06, 3}, {03, 3}, {04, 3}, {8, 7}, {02, 3}, {01, 3}
			},
			{
				{00, 3}, {9, 7}, {10, 7}, {11, 1}, {10, 1}, {9, 1}, {8, 1}, {07, 1}
			},
			{
				{06, 1}, {03, 1}, {04, 1}, {02, 1}, {00, 7}, {01, 1}, {07, 7}, {05, 7}
			},
			{
				{00, 1}, {9, 6}, {11, 6}, {07, 6}, {10, 6}, {06, 6}, {05, 6}, {04, 6}
			},
			{
				{03, 6}, {02, 6}, {01, 6}, {10, 4}, {11, 4}, {9, 4}, {8, 4}, {00, 4}
			},
			{
				{07, 4}, {06, 4}, {03, 4}, {11, 7}, {04, 4}, {02, 4}, {01, 4}, {06, 7}
			}
		},
	},
	//m-4
	{
		{
			{
				{11, 6}, {11, 5}, {11, 4}, {11, 2}, {11, 3}, {11, 1}, {8, 3}, {8, 2}
			},
			{
				{11, 0}, {10, 6}, {10, 5}, {10, 3}, {10, 4}, {10, 2}, {10, 1}, {10, 0}
			},
			{
				{9, 5}, {9, 4}, {9, 3}, {9, 1}, {9, 2}, {9, 0}, {8, 5}, {8, 4}
			},
			{
				{06, 3}, {06, 2}, {06, 1}, {06, 0}, {05, 7}, {07, 6}, {07, 5}, {07, 4}
			},
			{
				{07, 3}, {07, 2}, {07, 1}, {06, 7}, {07, 0}, {06, 6}, {06, 5}, {06, 4}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {05, 6}, {05, 5}, {10, 7}
			},
			{
				{9, 7}, {03, 4}, {03, 3}, {03, 2}, {03, 1}, {03, 0}, {04, 7}, {04, 6}
			},
			{
				{04, 5}, {04, 4}, {04, 3}, {04, 2}, {04, 1}, {04, 0}, {03, 7}, {03, 6}
			},
			{
				{9, 6}, {03, 5}, {11, 7}, {8, 6}, {8, 7}, {00, 7}, {8, 1}, {07, 7}
			},
			{
				{00, 6}, {02, 7}, {02, 6}, {02, 4}, {02, 5}, {02, 3}, {02, 2}, {02, 1}
			},
			{
				{02, 0}, {01, 7}, {01, 6}, {01, 4}, {01, 5}, {01, 3}, {01, 2}, {00, 0}
			},
			{
				{01, 1}, {01, 0}, {00, 5}, {00, 3}, {00, 4}, {00, 2}, {00, 1}, {8, 0}
			}
		},
	},
	//m-5
	{
		{
			{
				{11, 3}, {10, 3}, {9, 3}, {07, 3}, {8, 3}, {06, 3}, {01, 4}, {00, 4}
			},
			{
				{03, 3}, {04, 3}, {8, 7}, {01, 3}, {02, 3}, {00, 3}, {11, 4}, {10, 4}
			},
			{
				{9, 4}, {8, 4}, {07, 4}, {03, 4}, {06, 4}, {04, 4}, {11, 7}, {02, 4}
			},
			{
				{9, 2}, {8, 2}, {07, 2}, {06, 2}, {03, 2}, {8, 0}, {07, 0}, {06, 0}
			},
			{
				{03, 0}, {04, 0}, {00, 6}, {01, 0}, {02, 0}, {00, 0}, {11, 2}, {10, 2}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {04, 2}, {8, 6}, {02, 2}
			},
			{
				{01, 2}, {00, 2}, {07, 7}, {06, 7}, {05, 7}, {04, 7}, {03, 7}, {02, 7}
			},
			{
				{01, 7}, {9, 6}, {10, 7}, {11, 5}, {10, 5}, {9, 5}, {8, 5}, {07, 5}
			},
			{
				{06, 5}, {05, 5}, {04, 5}, {02, 5}, {03, 5}, {01, 5}, {11, 0}, {9, 0}
			},
			{
				{00, 5}, {9, 7}, {11, 1}, {9, 1}, {10, 1}, {8, 1}, {07, 1}, {06, 1}
			},
			{
				{03, 1}, {04, 1}, {00, 7}, {01, 1}, {02, 1}, {00, 1}, {11, 6}, {01, 6}
			},
			{
				{10, 6}, {07, 6}, {06, 6}, {04, 6}, {05, 6}, {03, 6}, {02, 6}, {10, 0}
			}
		},
	},
	//m-6
	{
		{
			{
				{11, 1}, {10, 1}, {9, 1}, {07, 1}, {8, 1}, {06, 1}, {01, 2}, {00, 2}
			},
			{
				{03, 1}, {04, 1}, {00, 7}, {01, 1}, {02, 1}, {00, 1}, {11, 2}, {10, 2}
			},
			{
				{9, 2}, {8, 2}, {07, 2}, {03, 2}, {06, 2}, {04, 2}, {8, 6}, {02, 2}
			},
			{
				{02, 6}, {01, 6}, {11, 5}, {10, 5}, {9, 5}, {04, 7}, {03, 7}, {02, 7}
			},
			{
				{01, 7}, {11, 6}, {10, 6}, {06, 6}, {07, 6}, {05, 6}, {04, 6}, {03, 6}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 5}, {07, 5}, {06, 5}
			},
			{
				{05, 5}, {04, 5}, {03, 5}, {02, 5}, {01, 5}, {00, 5}, {9, 6}, {9, 7}
			},
			{
				{11, 4}, {10, 4}, {9, 4}, {8, 4}, {07, 4}, {06, 4}, {03, 4}, {04, 4}
			},
			{
				{11, 7}, {02, 4}, {01, 4}, {10, 7}, {00, 4}, {11, 3}, {07, 7}, {05, 7}
			},
			{
				{10, 3}, {9, 3}, {8, 3}, {06, 3}, {07, 3}, {03, 3}, {04, 3}, {8, 7}
			},
			{
				{02, 3}, {01, 3}, {00, 3}, {10, 0}, {11, 0}, {9, 0}, {8, 0}, {00, 0}
			},
			{
				{07, 0}, {06, 0}, {03, 0}, {00, 6}, {04, 0}, {02, 0}, {01, 0}, {06, 7}
			}
		},
	},
	//m-7
	{
		{
			{
				{04, 5}, {8, 7}, {03, 6}, {11, 7}, {04, 2}, {03, 7}, {05, 6}, {05, 5}
			},
			{
				{04, 6}, {04, 0}, {03, 5}, {00, 7}, {8, 6}, {00, 6}, {04, 7}, {04, 4}
			},
			{
				{04, 3}, {04, 1}, {06, 7}, {05, 7}, {07, 4}, {03, 3}, {8, 3}, {9, 2}
			},
			{
				{11, 2}, {11, 1}, {07, 3}, {07, 2}, {8, 2}, {07, 5}, {06, 6}, {06, 5}
			},
			{
				{06, 4}, {07, 1}, {07, 0}, {9, 3}, {9, 4}, {10, 3}, {10, 2}, {11, 3}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 1}, {8, 0}, {9, 5}
			},
			{
				{10, 6}, {10, 5}, {10, 4}, {10, 1}, {10, 0}, {11, 6}, {9, 1}, {9, 0}
			},
			{
				{06, 3}, {06, 2}, {06, 1}, {06, 0}, {03, 2}, {03, 1}, {03, 0}, {11, 5}
			},
			{
				{11, 4}, {8, 5}, {8, 4}, {9, 6}, {11, 0}, {10, 7}, {03, 4}, {07, 6}
			},
			{
				{9, 7}, {01, 3}, {02, 5}, {02, 3}, {00, 4}, {00, 5}, {00, 0}, {01, 7}
			},
			{
				{01, 6}, {01, 1}, {01, 0}, {00, 3}, {02, 7}, {00, 2}, {00, 1}, {02, 4}
			},
			{
				{02, 2}, {02, 1}, {02, 0}, {01, 4}, {01, 5}, {02, 6}, {01, 2}, {07, 7}
			}
		},
	},
	//m-8
	{
		{
			{
				{07, 7}, {06, 7}, {05, 7}, {03, 7}, {04, 7}, {02, 7}, {05, 5}, {04, 5}
			},
			{
				{01, 7}, {11, 6}, {10, 6}, {06, 6}, {07, 6}, {05, 6}, {04, 6}, {03, 6}
			},
			{
				{02, 6}, {01, 6}, {11, 5}, {9, 5}, {10, 5}, {8, 5}, {07, 5}, {06, 5}
			},
			{
				{01, 4}, {00, 4}, {11, 3}, {10, 3}, {9, 3}, {00, 5}, {11, 4}, {10, 4}
			},
			{
				{9, 4}, {8, 4}, {07, 4}, {03, 4}, {06, 4}, {04, 4}, {11, 7}, {02, 4}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 3}, {07, 3}, {06, 3}
			},
			{
				{03, 3}, {04, 3}, {8, 7}, {02, 3}, {01, 3}, {00, 3}, {10, 7}, {9, 6}
			},
			{
				{11, 2}, {10, 2}, {9, 2}, {8, 2}, {07, 2}, {06, 2}, {03, 2}, {04, 2}
			},
			{
				{8, 6}, {02, 2}, {01, 2}, {9, 7}, {00, 2}, {11, 1}, {03, 5}, {01, 5}
			},
			{
				{10, 1}, {9, 1}, {8, 1}, {06, 1}, {07, 1}, {03, 1}, {04, 1}, {00, 7}
			},
			{
				{02, 1}, {01, 1}, {00, 1}, {10, 0}, {11, 0}, {9, 0}, {8, 0}, {00, 0}
			},
			{
				{07, 0}, {06, 0}, {03, 0}, {00, 6}, {04, 0}, {02, 0}, {01, 0}, {02, 5}
			}
		},
	},
	//m-9
	{
		{
			{
				{11, 1}, {10, 1}, {9, 1}, {07, 1}, {8, 1}, {06, 1}, {01, 3}, {00, 3}
			},
			{
				{03, 1}, {04, 1}, {00, 7}, {01, 1}, {02, 1}, {00, 1}, {11, 3}, {10, 3}
			},
			{
				{9, 3}, {8, 3}, {07, 3}, {03, 3}, {06, 3}, {04, 3}, {8, 7}, {02, 3}
			},
			{
				{05, 7}, {04, 7}, {03, 7}, {02, 7}, {01, 7}, {8, 5}, {07, 5}, {06, 5}
			},
			{
				{05, 5}, {04, 5}, {03, 5}, {01, 5}, {02, 5}, {00, 5}, {07, 7}, {06, 7}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {11, 0}, {10, 0}, {9, 0}
			},
			{
				{8, 0}, {07, 0}, {06, 0}, {03, 0}, {04, 0}, {00, 6}, {02, 0}, {01, 0}
			},
			{
				{00, 0}, {9, 6}, {9, 7}, {11, 2}, {10, 2}, {9, 2}, {8, 2}, {07, 2}
			},
			{
				{06, 2}, {03, 2}, {04, 2}, {02, 2}, {8, 6}, {01, 2}, {11, 5}, {9, 5}
			},
			{
				{00, 2}, {10, 7}, {11, 4}, {9, 4}, {10, 4}, {8, 4}, {07, 4}, {06, 4}
			},
			{
				{03, 4}, {04, 4}, {11, 7}, {01, 4}, {02, 4}, {00, 4}, {11, 6}, {01, 6}
			},
			{
				{10, 6}, {07, 6}, {06, 6}, {04, 6}, {05, 6}, {03, 6}, {02, 6}, {10, 5}
			}
		},
	},
	//m-10
	{
		{
			{
				{06, 5}, {02, 6}, {00, 2}, {02, 2}, {00, 5}, {04, 4}, {06, 7}, {06, 6}
			},
			{
				{02, 7}, {04, 5}, {00, 1}, {02, 5}, {04, 3}, {00, 4}, {02, 3}, {04, 7}
			},
			{
				{04, 0}, {04, 6}, {00, 3}, {04, 2}, {02, 1}, {04, 1}, {02, 4}, {02, 0}
			},
			{
				{8, 2}, {8, 0}, {10, 3}, {10, 6}, {10, 1}, {06, 2}, {06, 1}, {06, 0}
			},
			{
				{8, 1}, {10, 5}, {8, 5}, {10, 4}, {8, 4}, {10, 2}, {8, 3}, {10, 0}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {10, 7}, {9, 7}, {11, 4}
			},
			{
				{11, 3}, {11, 6}, {11, 5}, {11, 2}, {11, 1}, {11, 0}, {9, 0}, {9, 3}
			},
			{
				{9, 2}, {9, 5}, {9, 4}, {9, 1}, {07, 7}, {07, 6}, {9, 6}, {07, 5}
			},
			{
				{07, 4}, {05, 7}, {07, 2}, {07, 0}, {07, 1}, {07, 3}, {00, 0}, {06, 3}
			},
			{
				{05, 6}, {05, 5}, {03, 4}, {03, 2}, {03, 3}, {03, 1}, {03, 0}, {01, 5}
			},
			{
				{01, 1}, {03, 5}, {03, 7}, {01, 0}, {01, 7}, {03, 6}, {11, 7}, {01, 2}
			},
			{
				{8, 7}, {8, 6}, {00, 7}, {01, 6}, {00, 6}, {01, 4}, {01, 3}, {06, 4}
			}
		},
	},
	//m-11
	{
		{
			{
				{11, 0}, {10, 0}, {9, 0}, {07, 0}, {8, 0}, {06, 0}, {01, 2}, {00, 2}
			},
			{
				{03, 0}, {04, 0}, {00, 6}, {01, 0}, {02, 0}, {00, 0}, {11, 2}, {10, 2}
			},
			{
				{9, 2}, {8, 2}, {07, 2}, {03, 2}, {06, 2}, {04, 2}, {8, 6}, {02, 2}
			},
			{
				{07, 6}, {06, 6}, {05, 6}, {04, 6}, {03, 6}, {8, 4}, {07, 4}, {06, 4}
			},
			{
				{03, 4}, {04, 4}, {11, 7}, {01, 4}, {02, 4}, {00, 4}, {11, 6}, {10, 6}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {02, 6}, {01, 6}, {11, 1}
			},
			{
				{10, 1}, {9, 1}, {8, 1}, {07, 1}, {06, 1}, {03, 1}, {04, 1}, {00, 7}
			},
			{
				{02, 1}, {01, 1}, {00, 1}, {9, 6}, {9, 7}, {11, 3}, {10, 3}, {9, 3}
			},
			{
				{8, 3}, {07, 3}, {06, 3}, {04, 3}, {03, 3}, {8, 7}, {11, 4}, {9, 4}
			},
			{
				{02, 3}, {01, 3}, {00, 3}, {11, 5}, {10, 7}, {10, 5}, {9, 5}, {8, 5}
			},
			{
				{07, 5}, {06, 5}, {05, 5}, {03, 5}, {04, 5}, {02, 5}, {01, 5}, {01, 7}
			},
			{
				{00, 5}, {07, 7}, {06, 7}, {04, 7}, {05, 7}, {03, 7}, {02, 7}, {10, 4}
			}
		},
	},
	//m-12
	{
		{
			{
				{04, 7}, {8, 0}, {04, 5}, {04, 1}, {04, 4}, {04, 2}, {07, 6}, {07, 5}
			},
			{
				{04, 3}, {8, 4}, {8, 5}, {8, 2}, {8, 3}, {8, 1}, {04, 6}, {04, 0}
			},
			{
				{11, 4}, {11, 6}, {11, 5}, {11, 2}, {11, 3}, {11, 1}, {11, 0}, {07, 7}
			},
			{
				{05, 7}, {01, 5}, {01, 4}, {01, 3}, {01, 2}, {07, 1}, {07, 0}, {03, 7}
			},
			{
				{03, 6}, {03, 5}, {11, 7}, {07, 2}, {8, 7}, {00, 7}, {00, 6}, {01, 7}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {01, 1}, {01, 0}, {01, 6}
			},
			{
				{05, 6}, {05, 5}, {03, 4}, {03, 3}, {9, 1}, {03, 1}, {03, 0}, {9, 5}
			},
			{
				{9, 4}, {9, 3}, {9, 2}, {03, 2}, {9, 0}, {9, 7}, {10, 7}, {10, 6}
			},
			{
				{9, 6}, {10, 5}, {10, 4}, {06, 7}, {10, 3}, {10, 1}, {07, 4}, {8, 6}
			},
			{
				{10, 0}, {10, 2}, {06, 6}, {06, 4}, {06, 5}, {02, 6}, {06, 2}, {06, 1}
			},
			{
				{06, 0}, {02, 7}, {06, 3}, {02, 1}, {02, 5}, {02, 3}, {02, 2}, {00, 1}
			},
			{
				{02, 4}, {02, 0}, {00, 5}, {00, 3}, {00, 4}, {00, 2}, {00, 0}, {07, 3}
			}
		},
	},
	//m-13
	{
		{
			{
				{11, 2}, {10, 2}, {9, 2}, {07, 2}, {8, 2}, {06, 2}, {01, 0}, {00, 0}
			},
			{
				{03, 2}, {04, 2}, {8, 6}, {01, 2}, {02, 2}, {00, 2}, {11, 0}, {10, 0}
			},
			{
				{9, 0}, {8, 0}, {07, 0}, {03, 0}, {06, 0}, {04, 0}, {00, 6}, {02, 0}
			},
			{
				{9, 5}, {8, 5}, {07, 5}, {06, 5}, {05, 5}, {8, 3}, {07, 3}, {06, 3}
			},
			{
				{03, 3}, {04, 3}, {8, 7}, {01, 3}, {02, 3}, {00, 3}, {11, 5}, {10, 5}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {04, 5}, {03, 5}, {02, 5}
			},
			{
				{01, 5}, {00, 5}, {11, 4}, {10, 4}, {9, 4}, {8, 4}, {07, 4}, {06, 4}
			},
			{
				{03, 4}, {04, 4}, {11, 7}, {02, 4}, {01, 4}, {10, 7}, {9, 6}, {00, 4}
			},
			{
				{11, 6}, {10, 6}, {07, 6}, {05, 6}, {06, 6}, {04, 6}, {11, 3}, {9, 3}
			},
			{
				{03, 6}, {02, 6}, {01, 6}, {07, 7}, {9, 7}, {06, 7}, {05, 7}, {04, 7}
			},
			{
				{03, 7}, {02, 7}, {01, 7}, {10, 1}, {11, 1}, {9, 1}, {8, 1}, {00, 1}
			},
			{
				{07, 1}, {06, 1}, {03, 1}, {00, 7}, {04, 1}, {02, 1}, {01, 1}, {10, 3}
			}
		},
	},
	//m-14
	{
		{
			{
				{00, 5}, {11, 4}, {10, 4}, {8, 4}, {9, 4}, {07, 4}, {02, 3}, {01, 3}
			},
			{
				{06, 4}, {03, 4}, {04, 4}, {02, 4}, {11, 7}, {01, 4}, {00, 4}, {11, 3}
			},
			{
				{10, 3}, {9, 3}, {8, 3}, {06, 3}, {07, 3}, {03, 3}, {04, 3}, {8, 7}
			},
			{
				{10, 1}, {9, 1}, {8, 1}, {07, 1}, {06, 1}, {9, 2}, {8, 2}, {07, 2}
			},
			{
				{06, 2}, {03, 2}, {04, 2}, {02, 2}, {8, 6}, {01, 2}, {00, 2}, {11, 1}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {03, 1}, {04, 1}, {00, 7}
			},
			{
				{02, 1}, {01, 1}, {00, 1}, {11, 0}, {10, 0}, {9, 0}, {8, 0}, {07, 0}
			},
			{
				{06, 0}, {03, 0}, {04, 0}, {00, 6}, {02, 0}, {01, 0}, {10, 7}, {9, 6}
			},
			{
				{00, 0}, {07, 7}, {06, 7}, {04, 7}, {05, 7}, {03, 7}, {00, 3}, {10, 2}
			},
			{
				{02, 7}, {01, 7}, {9, 7}, {10, 6}, {11, 6}, {07, 6}, {06, 6}, {05, 6}
			},
			{
				{04, 6}, {03, 6}, {02, 6}, {11, 5}, {01, 6}, {10, 5}, {9, 5}, {01, 5}
			},
			{
				{8, 5}, {07, 5}, {06, 5}, {04, 5}, {05, 5}, {03, 5}, {02, 5}, {11, 2}
			}
		},
	},
	//m-15
	{
		{
			{
				{06, 7}, {06, 6}, {06, 5}, {06, 3}, {06, 4}, {06, 2}, {07, 7}, {07, 6}
			},
			{
				{06, 1}, {06, 0}, {05, 7}, {05, 5}, {05, 6}, {03, 4}, {03, 3}, {03, 2}
			},
			{
				{03, 1}, {03, 0}, {8, 5}, {8, 3}, {8, 4}, {8, 2}, {8, 1}, {8, 0}
			},
			{
				{11, 5}, {11, 4}, {11, 3}, {11, 2}, {11, 1}, {07, 2}, {07, 1}, {07, 0}
			},
			{
				{10, 6}, {10, 5}, {10, 4}, {10, 2}, {10, 3}, {10, 1}, {10, 0}, {11, 6}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {11, 0}, {10, 7}, {9, 6}
			},
			{
				{00, 5}, {00, 4}, {00, 3}, {00, 2}, {00, 1}, {00, 0}, {01, 7}, {01, 6}
			},
			{
				{01, 5}, {01, 4}, {01, 3}, {01, 2}, {01, 1}, {01, 0}, {9, 7}, {04, 7}
			},
			{
				{04, 6}, {04, 5}, {04, 4}, {04, 2}, {04, 3}, {04, 1}, {07, 5}, {07, 3}
			},
			{
				{04, 0}, {03, 7}, {03, 6}, {11, 7}, {03, 5}, {8, 7}, {8, 6}, {00, 7}
			},
			{
				{00, 6}, {02, 7}, {02, 6}, {02, 4}, {02, 5}, {02, 3}, {02, 2}, {9, 0}
			},
			{
				{02, 1}, {02, 0}, {9, 5}, {9, 3}, {9, 4}, {9, 2}, {9, 1}, {07, 4}
			}
		},
	},
	//m-16
	{
		{
			{
				{11, 2}, {10, 2}, {9, 2}, {07, 2}, {8, 2}, {06, 2}, {01, 3}, {00, 3}
			},
			{
				{03, 2}, {04, 2}, {8, 6}, {01, 2}, {02, 2}, {00, 2}, {11, 3}, {10, 3}
			},
			{
				{9, 3}, {8, 3}, {07, 3}, {03, 3}, {06, 3}, {04, 3}, {8, 7}, {02, 3}
			},
			{
				{9, 5}, {8, 5}, {07, 5}, {06, 5}, {05, 5}, {8, 4}, {07, 4}, {06, 4}
			},
			{
				{03, 4}, {04, 4}, {11, 7}, {01, 4}, {02, 4}, {00, 4}, {11, 5}, {10, 5}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {04, 5}, {03, 5}, {02, 5}
			},
			{
				{01, 5}, {00, 5}, {07, 7}, {06, 7}, {05, 7}, {04, 7}, {03, 7}, {02, 7}
			},
			{
				{01, 7}, {9, 7}, {9, 6}, {11, 6}, {10, 6}, {07, 6}, {06, 6}, {05, 6}
			},
			{
				{04, 6}, {03, 6}, {02, 6}, {10, 7}, {01, 6}, {11, 1}, {11, 4}, {9, 4}
			},
			{
				{10, 1}, {9, 1}, {8, 1}, {06, 1}, {07, 1}, {03, 1}, {04, 1}, {00, 7}
			},
			{
				{02, 1}, {01, 1}, {00, 1}, {10, 0}, {11, 0}, {9, 0}, {8, 0}, {00, 0}
			},
			{
				{07, 0}, {06, 0}, {03, 0}, {00, 6}, {04, 0}, {02, 0}, {01, 0}, {10, 4}
			}
		},
	},
	//m-17
	{
		{
			{
				{00, 4}, {06, 7}, {00, 3}, {00, 1}, {00, 5}, {06, 1}, {02, 1}, {02, 0}
			},
			{
				{06, 4}, {04, 3}, {02, 7}, {00, 2}, {02, 3}, {02, 5}, {06, 6}, {06, 5}
			},
			{
				{06, 3}, {06, 2}, {06, 0}, {04, 6}, {04, 7}, {04, 5}, {04, 4}, {02, 2}
			},
			{
				{10, 1}, {10, 0}, {01, 7}, {01, 6}, {01, 5}, {02, 6}, {02, 4}, {00, 0}
			},
			{
				{03, 5}, {8, 5}, {10, 4}, {8, 4}, {01, 4}, {10, 5}, {10, 3}, {10, 2}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 3}, {8, 2}, {8, 1}
			},
			{
				{8, 0}, {01, 3}, {01, 2}, {01, 1}, {01, 0}, {03, 7}, {03, 6}, {11, 7}
			},
			{
				{8, 7}, {8, 6}, {10, 6}, {9, 7}, {9, 6}, {05, 5}, {07, 5}, {00, 7}
			},
			{
				{03, 4}, {03, 3}, {03, 2}, {05, 7}, {00, 6}, {05, 6}, {04, 2}, {04, 0}
			},
			{
				{07, 4}, {07, 3}, {03, 1}, {07, 7}, {03, 0}, {07, 6}, {10, 7}, {9, 5}
			},
			{
				{9, 1}, {07, 2}, {07, 1}, {9, 4}, {07, 0}, {9, 3}, {9, 2}, {11, 0}
			},
			{
				{11, 6}, {9, 0}, {11, 5}, {11, 3}, {11, 4}, {11, 2}, {11, 1}, {04, 1}
			}
		},
	},
	//m-18
	{
		{
			{
				{07, 7}, {06, 7}, {05, 7}, {03, 7}, {04, 7}, {02, 7}, {03, 0}, {04, 0}
			},
			{
				{01, 7}, {11, 6}, {10, 6}, {06, 6}, {07, 6}, {05, 6}, {04, 6}, {03, 6}
			},
			{
				{02, 6}, {01, 6}, {11, 0}, {9, 0}, {10, 0}, {8, 0}, {07, 0}, {06, 0}
			},
			{
				{01, 1}, {00, 1}, {11, 2}, {10, 2}, {9, 2}, {00, 0}, {11, 1}, {10, 1}
			},
			{
				{9, 1}, {8, 1}, {07, 1}, {03, 1}, {06, 1}, {04, 1}, {00, 7}, {02, 1}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 2}, {07, 2}, {06, 2}
			},
			{
				{03, 2}, {04, 2}, {8, 6}, {02, 2}, {01, 2}, {00, 2}, {9, 7}, {9, 6}
			},
			{
				{11, 3}, {10, 3}, {9, 3}, {8, 3}, {07, 3}, {06, 3}, {03, 3}, {04, 3}
			},
			{
				{8, 7}, {02, 3}, {01, 3}, {10, 7}, {00, 3}, {11, 5}, {00, 6}, {01, 0}
			},
			{
				{10, 5}, {9, 5}, {8, 5}, {06, 5}, {07, 5}, {05, 5}, {04, 5}, {03, 5}
			},
			{
				{02, 5}, {01, 5}, {00, 5}, {10, 4}, {11, 4}, {9, 4}, {8, 4}, {00, 4}
			},
			{
				{07, 4}, {06, 4}, {03, 4}, {11, 7}, {04, 4}, {02, 4}, {01, 4}, {02, 0}
			}
		},
	},
	//m-19
	{
		{
			{
				{9, 1}, {03, 4}, {01, 5}, {8, 7}, {9, 5}, {07, 5}, {03, 3}, {03, 2}
			},
			{
				{01, 7}, {01, 6}, {01, 1}, {00, 6}, {01, 0}, {05, 7}, {07, 2}, {07, 1}
			},
			{
				{03, 7}, {03, 6}, {01, 4}, {9, 4}, {01, 3}, {9, 3}, {03, 5}, {11, 7}
			},
			{
				{11, 6}, {11, 5}, {11, 4}, {11, 1}, {11, 3}, {8, 6}, {00, 7}, {07, 4}
			},
			{
				{07, 3}, {05, 6}, {05, 5}, {07, 0}, {9, 0}, {03, 1}, {03, 0}, {01, 2}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {11, 2}, {00, 5}, {00, 4}
			},
			{
				{11, 0}, {02, 1}, {02, 0}, {00, 1}, {00, 0}, {04, 7}, {04, 6}, {04, 5}
			},
			{
				{02, 7}, {02, 6}, {00, 3}, {00, 2}, {02, 5}, {02, 4}, {02, 3}, {02, 2}
			},
			{
				{10, 7}, {9, 6}, {04, 0}, {04, 2}, {06, 1}, {04, 1}, {07, 7}, {9, 2}
			},
			{
				{06, 7}, {06, 6}, {04, 4}, {06, 0}, {04, 3}, {06, 5}, {06, 4}, {06, 3}
			},
			{
				{06, 2}, {9, 7}, {8, 1}, {8, 4}, {8, 5}, {8, 3}, {8, 2}, {10, 0}
			},
			{
				{8, 0}, {10, 6}, {10, 4}, {10, 5}, {10, 2}, {10, 3}, {10, 1}, {07, 6}
			}
		},
	},
	//m-20
	{
		{
			{
				{11, 1}, {11, 6}, {11, 0}, {11, 5}, {11, 4}, {11, 3}, {07, 5}, {07, 4}
			},
			{
				{11, 2}, {05, 5}, {03, 0}, {9, 5}, {05, 7}, {9, 4}, {9, 3}, {07, 6}
			},
			{
				{07, 0}, {03, 3}, {03, 2}, {9, 2}, {03, 1}, {9, 1}, {9, 0}, {05, 6}
			},
			{
				{8, 7}, {01, 1}, {01, 0}, {01, 5}, {01, 4}, {07, 1}, {03, 4}, {03, 7}
			},
			{
				{11, 7}, {01, 2}, {03, 6}, {01, 7}, {03, 5}, {01, 6}, {8, 6}, {00, 7}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {01, 3}, {10, 6}, {10, 5}
			},
			{
				{00, 6}, {10, 7}, {9, 6}, {8, 5}, {10, 3}, {06, 7}, {10, 4}, {06, 6}
			},
			{
				{10, 2}, {10, 1}, {10, 0}, {8, 3}, {8, 2}, {8, 1}, {8, 0}, {8, 4}
			},
			{
				{9, 7}, {06, 2}, {06, 4}, {04, 7}, {04, 6}, {06, 5}, {07, 3}, {07, 2}
			},
			{
				{06, 1}, {06, 0}, {06, 3}, {02, 5}, {02, 6}, {04, 4}, {04, 3}, {04, 0}
			},
			{
				{02, 7}, {00, 4}, {00, 3}, {02, 3}, {02, 4}, {04, 5}, {00, 5}, {02, 0}
			},
			{
				{02, 2}, {02, 1}, {04, 2}, {00, 2}, {04, 1}, {00, 1}, {00, 0}, {07, 7}
			}
		},
	},
	//m-21
	{
		{
			{
				{11, 5}, {10, 5}, {9, 5}, {8, 5}, {07, 5}, {06, 5}, {10, 0}, {9, 0}
			},
			{
				{05, 5}, {04, 5}, {03, 5}, {01, 5}, {02, 5}, {00, 5}, {11, 6}, {10, 6}
			},
			{
				{07, 6}, {06, 6}, {05, 6}, {03, 6}, {04, 6}, {02, 6}, {01, 6}, {11, 0}
			},
			{
				{06, 1}, {03, 1}, {04, 1}, {00, 7}, {02, 1}, {03, 0}, {04, 0}, {00, 6}
			},
			{
				{02, 0}, {01, 0}, {00, 0}, {10, 1}, {11, 1}, {9, 1}, {8, 1}, {07, 1}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {01, 1}, {00, 1}, {11, 2}
			},
			{
				{10, 2}, {9, 2}, {8, 2}, {07, 2}, {06, 2}, {03, 2}, {04, 2}, {8, 6}
			},
			{
				{02, 2}, {01, 2}, {00, 2}, {9, 7}, {9, 6}, {11, 3}, {10, 3}, {9, 3}
			},
			{
				{8, 3}, {07, 3}, {06, 3}, {04, 3}, {03, 3}, {8, 7}, {8, 0}, {06, 0}
			},
			{
				{02, 3}, {01, 3}, {00, 3}, {11, 4}, {10, 7}, {10, 4}, {9, 4}, {8, 4}
			},
			{
				{07, 4}, {06, 4}, {03, 4}, {11, 7}, {04, 4}, {02, 4}, {01, 4}, {01, 7}
			},
			{
				{00, 4}, {07, 7}, {06, 7}, {04, 7}, {05, 7}, {03, 7}, {02, 7}, {07, 0}
			}
		},
	},
	//m-22
	{
		{
			{
				{01, 7}, {01, 6}, {01, 5}, {01, 4}, {01, 3}, {01, 2}, {07, 1}, {07, 0}
			},
			{
				{01, 1}, {01, 0}, {04, 7}, {04, 5}, {04, 6}, {04, 4}, {04, 3}, {04, 2}
			},
			{
				{04, 1}, {04, 0}, {07, 7}, {07, 5}, {07, 6}, {07, 4}, {07, 3}, {07, 2}
			},
			{
				{02, 6}, {02, 5}, {02, 4}, {02, 3}, {02, 2}, {10, 3}, {10, 2}, {10, 1}
			},
			{
				{10, 0}, {00, 5}, {00, 4}, {00, 2}, {00, 3}, {00, 1}, {00, 0}, {02, 7}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {02, 1}, {02, 0}, {05, 7}
			},
			{
				{05, 6}, {05, 5}, {03, 4}, {03, 3}, {03, 2}, {03, 1}, {03, 0}, {8, 5}
			},
			{
				{8, 4}, {8, 3}, {8, 2}, {8, 1}, {8, 0}, {11, 6}, {11, 5}, {11, 4}
			},
			{
				{11, 3}, {11, 2}, {11, 1}, {9, 7}, {11, 0}, {9, 6}, {10, 6}, {10, 4}
			},
			{
				{03, 7}, {03, 6}, {03, 5}, {8, 7}, {11, 7}, {8, 6}, {00, 7}, {00, 6}
			},
			{
				{10, 7}, {06, 7}, {06, 6}, {06, 4}, {06, 5}, {06, 3}, {06, 2}, {9, 0}
			},
			{
				{06, 1}, {06, 0}, {9, 5}, {9, 3}, {9, 4}, {9, 2}, {9, 1}, {10, 5}
			}
		},
	},
	//m-23
	{
		{
			{
				{07, 7}, {06, 7}, {05, 7}, {04, 7}, {03, 7}, {02, 7}, {03, 2}, {04, 2}
			},
			{
				{01, 7}, {11, 6}, {10, 6}, {06, 6}, {07, 6}, {05, 6}, {04, 6}, {03, 6}
			},
			{
				{02, 6}, {01, 6}, {11, 2}, {9, 2}, {10, 2}, {8, 2}, {07, 2}, {06, 2}
			},
			{
				{01, 3}, {00, 3}, {11, 0}, {10, 0}, {9, 0}, {00, 2}, {11, 3}, {10, 3}
			},
			{
				{9, 3}, {8, 3}, {07, 3}, {03, 3}, {06, 3}, {04, 3}, {8, 7}, {02, 3}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 0}, {07, 0}, {06, 0}
			},
			{
				{03, 0}, {04, 0}, {00, 6}, {02, 0}, {01, 0}, {00, 0}, {10, 7}, {9, 6}
			},
			{
				{11, 1}, {10, 1}, {9, 1}, {8, 1}, {07, 1}, {06, 1}, {03, 1}, {04, 1}
			},
			{
				{00, 7}, {02, 1}, {01, 1}, {9, 7}, {00, 1}, {11, 4}, {8, 6}, {01, 2}
			},
			{
				{10, 4}, {9, 4}, {8, 4}, {06, 4}, {07, 4}, {03, 4}, {04, 4}, {11, 7}
			},
			{
				{02, 4}, {01, 4}, {00, 4}, {10, 5}, {11, 5}, {9, 5}, {8, 5}, {00, 5}
			},
			{
				{07, 5}, {06, 5}, {05, 5}, {03, 5}, {04, 5}, {02, 5}, {01, 5}, {02, 2}
			}
		},
	},
	//m-24
	{
		{
			{
				{07, 0}, {06, 5}, {06, 6}, {07, 5}, {06, 4}, {07, 4}, {8, 4}, {8, 2}
			},
			{
				{06, 7}, {06, 3}, {07, 3}, {07, 1}, {07, 2}, {06, 2}, {06, 1}, {06, 0}
			},
			{
				{07, 7}, {07, 6}, {8, 0}, {8, 1}, {8, 5}, {9, 5}, {9, 3}, {8, 3}
			},
			{
				{11, 1}, {11, 3}, {11, 2}, {11, 0}, {00, 5}, {9, 0}, {10, 5}, {10, 3}
			},
			{
				{10, 0}, {10, 6}, {10, 4}, {10, 1}, {10, 2}, {11, 4}, {11, 6}, {11, 5}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {10, 7}, {06, 9}, {00, 2}
			},
			{
				{00, 4}, {00, 3}, {00, 0}, {00, 1}, {01, 5}, {01, 7}, {01, 6}, {01, 4}
			},
			{
				{01, 3}, {01, 2}, {01, 1}, {01, 0}, {02, 6}, {02, 7}, {9, 7}, {02, 5}
			},
			{
				{02, 4}, {02, 3}, {02, 2}, {02, 0}, {02, 1}, {03, 7}, {9, 1}, {9, 2}
			},
			{
				{03, 6}, {03, 5}, {11, 7}, {8, 6}, {8, 7}, {00, 7}, {00, 6}, {04, 4}
			},
			{
				{03, 3}, {05, 6}, {04, 6}, {04, 1}, {04, 7}, {04, 5}, {03, 0}, {03, 1}
			},
			{
				{04, 0}, {04, 3}, {04, 2}, {03, 4}, {05, 5}, {05, 7}, {03, 2}, {9, 4}
			}
		},
	},
	//m-25
	{
		{
			{
				{03, 0}, {11, 4}, {07, 7}, {07, 0}, {05, 7}, {05, 6}, {03, 3}, {00, 0}
			},
			{
				{03, 2}, {03, 1}, {11, 3}, {11, 5}, {11, 6}, {07, 6}, {07, 5}, {07, 4}
			},
			{
				{07, 3}, {07, 2}, {07, 1}, {11, 1}, {11, 2}, {11, 0}, {05, 5}, {03, 4}
			},
			{
				{03, 7}, {01, 2}, {01, 1}, {11, 7}, {8, 7}, {03, 5}, {9, 1}, {9, 0}
			},
			{
				{01, 6}, {01, 5}, {9, 5}, {01, 4}, {9, 4}, {01, 3}, {00, 2}, {00, 1}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 6}, {00, 7}, {00, 6}
			},
			{
				{01, 7}, {01, 0}, {00, 5}, {00, 4}, {00, 3}, {8, 5}, {9, 6}, {9, 7}
			},
			{
				{8, 3}, {8, 4}, {8, 1}, {06, 7}, {8, 2}, {8, 0}, {06, 6}, {10, 7}
			},
			{
				{06, 1}, {06, 5}, {06, 4}, {06, 0}, {06, 3}, {10, 6}, {9, 3}, {03, 6}
			},
			{
				{06, 2}, {02, 7}, {02, 6}, {10, 4}, {10, 5}, {10, 1}, {10, 0}, {02, 3}
			},
			{
				{02, 2}, {04, 5}, {04, 4}, {04, 0}, {04, 1}, {02, 1}, {02, 0}, {02, 4}
			},
			{
				{10, 3}, {10, 2}, {04, 7}, {04, 3}, {04, 6}, {04, 2}, {02, 5}, {9, 2}
			}
		},
	},
	//m-26
	{
		{
			{
				{11, 0}, {10, 0}, {9, 0}, {8, 0}, {07, 0}, {06, 0}, {01, 1}, {00, 1}
			},
			{
				{03, 0}, {00, 6}, {04, 0}, {01, 0}, {02, 0}, {00, 0}, {11, 1}, {10, 1}
			},
			{
				{9, 1}, {8, 1}, {07, 1}, {03, 1}, {06, 1}, {04, 1}, {00, 7}, {02, 1}
			},
			{
				{02, 6}, {01, 6}, {11, 2}, {10, 2}, {9, 2}, {04, 7}, {03, 7}, {02, 7}
			},
			{
				{01, 7}, {11, 6}, {10, 6}, {06, 6}, {07, 6}, {05, 6}, {04, 6}, {03, 6}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {8, 2}, {07, 2}, {06, 2}
			},
			{
				{03, 2}, {04, 2}, {8, 6}, {02, 2}, {01, 2}, {00, 2}, {9, 7}, {9, 6}
			},
			{
				{11, 3}, {10, 3}, {9, 3}, {8, 3}, {07, 3}, {06, 3}, {03, 3}, {04, 3}
			},
			{
				{8, 7}, {02, 3}, {01, 3}, {10, 7}, {00, 3}, {11, 5}, {07, 7}, {05, 7}
			},
			{
				{10, 5}, {9, 5}, {8, 5}, {06, 5}, {07, 5}, {05, 5}, {04, 5}, {03, 5}
			},
			{
				{02, 5}, {01, 5}, {00, 5}, {10, 4}, {11, 4}, {9, 4}, {8, 4}, {00, 4}
			},
			{
				{07, 4}, {06, 4}, {03, 4}, {11, 7}, {04, 4}, {02, 4}, {01, 4}, {06, 7}
			}
		},
	},
	//m-27
	{
		{
			{
				{11, 3}, {10, 3}, {9, 3}, {8, 3}, {07, 3}, {06, 3}, {01, 4}, {00, 4}
			},
			{
				{03, 3}, {04, 3}, {8, 7}, {01, 3}, {02, 3}, {00, 3}, {11, 4}, {10, 4}
			},
			{
				{9, 4}, {8, 4}, {07, 4}, {03, 4}, {06, 4}, {04, 4}, {11, 7}, {02, 4}
			},
			{
				{06, 5}, {05, 5}, {04, 5}, {03, 5}, {02, 5}, {06, 6}, {05, 6}, {04, 6}
			},
			{
				{03, 6}, {02, 6}, {01, 6}, {10, 5}, {11, 5}, {9, 5}, {8, 5}, {07, 5}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {01, 5}, {00, 5}, {07, 7}
			},
			{
				{06, 7}, {05, 7}, {04, 7}, {03, 7}, {02, 7}, {01, 7}, {10, 7}, {9, 7}
			},
			{
				{11, 0}, {10, 0}, {9, 0}, {8, 0}, {07, 0}, {06, 0}, {03, 0}, {04, 0}
			},
			{
				{00, 6}, {02, 0}, {01, 0}, {9, 6}, {00, 0}, {11, 1}, {11, 6}, {07, 6}
			},
			{
				{10, 1}, {9, 1}, {8, 1}, {06, 1}, {07, 1}, {03, 1}, {04, 1}, {00, 7}
			},
			{
				{02, 1}, {01, 1}, {00, 1}, {10, 2}, {11, 2}, {9, 2}, {8, 2}, {00, 2}
			},
			{
				{07, 2}, {06, 2}, {03, 2}, {8, 6}, {04, 2}, {02, 2}, {01, 2}, {10, 6}
			}
		},
	},
	//m-28
	{
		{
			{
				{11, 7}, {02, 6}, {04, 4}, {02, 5}, {02, 7}, {00, 7}, {00, 6}, {04, 7}
			},
			{
				{04, 1}, {02, 4}, {02, 1}, {02, 2}, {02, 3}, {04, 6}, {04, 5}, {02, 0}
			},
			{
				{03, 7}, {04, 0}, {03, 6}, {8, 7}, {03, 5}, {8, 6}, {04, 3}, {04, 2}
			},
			{
				{06, 1}, {06, 0}, {07, 7}, {07, 5}, {07, 4}, {05, 6}, {03, 3}, {03, 2}
			},
			{
				{03, 1}, {06, 6}, {06, 7}, {06, 5}, {03, 0}, {06, 4}, {06, 3}, {06, 2}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {07, 3}, {07, 2}, {07, 1}
			},
			{
				{07, 0}, {07, 6}, {8, 5}, {8, 4}, {8, 3}, {8, 2}, {8, 0}, {8, 1}
			},
			{
				{9, 5}, {9, 4}, {9, 2}, {9, 1}, {9, 3}, {9, 0}, {10, 3}, {10, 5}
			},
			{
				{10, 4}, {10, 1}, {10, 2}, {10, 0}, {10, 6}, {11, 2}, {05, 7}, {05, 5}
			},
			{
				{11, 5}, {11, 4}, {11, 3}, {11, 1}, {11, 6}, {11, 0}, {9, 7}, {9, 6}
			},
			{
				{10, 7}, {01, 4}, {00, 5}, {00, 3}, {01, 1}, {00, 2}, {00, 1}, {01, 0}
			},
			{
				{00, 0}, {01, 7}, {01, 6}, {01, 3}, {01, 5}, {01, 2}, {00, 4}, {03, 4}
			}
		},
	},
	//m-29
	{
		{
			{
				{9, 3}, {01, 6}, {07, 6}, {11, 4}, {9, 0}, {01, 7}, {01, 0}, {11, 6}
			},
			{
				{01, 4}, {11, 2}, {07, 2}, {01, 5}, {07, 4}, {01, 1}, {9, 4}, {01, 3}
			},
			{
				{01, 2}, {07, 5}, {11, 1}, {07, 7}, {11, 0}, {07, 1}, {07, 0}, {9, 5}
			},
			{
				{03, 2}, {03, 1}, {03, 0}, {00, 7}, {00, 6}, {9, 2}, {9, 1}, {8, 6}
			},
			{
				{03, 4}, {05, 6}, {03, 5}, {03, 7}, {05, 7}, {03, 6}, {05, 5}, {03, 3}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {11, 7}, {8, 7}, {02, 7}
			},
			{
				{04, 2}, {06, 7}, {06, 6}, {04, 0}, {06, 5}, {02, 5}, {02, 4}, {04, 4}
			},
			{
				{04, 3}, {02, 6}, {02, 3}, {02, 2}, {02, 1}, {02, 0}, {04, 7}, {04, 6}
			},
			{
				{04, 5}, {04, 1}, {9, 6}, {8, 5}, {10, 7}, {06, 3}, {11, 5}, {07, 3}
			},
			{
				{06, 0}, {8, 1}, {06, 2}, {10, 6}, {06, 1}, {06, 4}, {8, 4}, {8, 3}
			},
			{
				{8, 2}, {8, 0}, {9, 7}, {10, 4}, {10, 5}, {10, 2}, {10, 1}, {00, 0}
			},
			{
				{10, 0}, {10, 3}, {00, 5}, {00, 4}, {00, 2}, {00, 3}, {00, 1}, {11, 3}
			}
		},
	},
	//m-30
	{
		{
			{
				{11, 1}, {10, 1}, {9, 1}, {8, 1}, {07, 1}, {06, 1}, {01, 0}, {00, 0}
			},
			{
				{03, 1}, {04, 1}, {00, 7}, {01, 1}, {02, 1}, {00, 1}, {11, 0}, {10, 0}
			},
			{
				{9, 0}, {8, 0}, {07, 0}, {03, 0}, {06, 0}, {04, 0}, {00, 6}, {02, 0}
			},
			{
				{9, 2}, {8, 2}, {07, 2}, {06, 2}, {03, 2}, {8, 3}, {07, 3}, {06, 3}
			},
			{
				{03, 3}, {04, 3}, {8, 7}, {01, 3}, {02, 3}, {00, 3}, {11, 2}, {10, 2}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {04, 2}, {8, 6}, {02, 2}
			},
			{
				{01, 2}, {00, 2}, {11, 5}, {10, 5}, {9, 5}, {8, 5}, {07, 5}, {06, 5}
			},
			{
				{05, 5}, {04, 5}, {03, 5}, {02, 5}, {01, 5}, {00, 5}, {10, 7}, {9, 6}
			},
			{
				{11, 4}, {10, 4}, {9, 4}, {07, 4}, {8, 4}, {06, 4}, {11, 3}, {9, 3}
			},
			{
				{03, 4}, {04, 4}, {11, 7}, {01, 4}, {02, 4}, {9, 7}, {00, 4}, {07, 7}
			},
			{
				{06, 7}, {05, 7}, {04, 7}, {02, 7}, {03, 7}, {01, 7}, {11, 6}, {01, 6}
			},
			{
				{10, 6}, {07, 6}, {06, 6}, {04, 6}, {05, 6}, {03, 6}, {02, 6}, {10, 3}
			}
		},
	},
	//m-31
	{
		{
			{
				{03, 3}, {03, 2}, {01, 7}, {01, 6}, {03, 7}, {03, 6}, {00, 3}, {00, 2}
			},
			{
				{00, 5}, {02, 3}, {02, 2}, {04, 2}, {04, 3}, {07, 3}, {07, 2}, {8, 5}
			},
			{
				{9, 3}, {9, 2}, {02, 1}, {05, 7}, {02, 0}, {05, 6}, {05, 5}, {03, 4}
			},
			{
				{02, 7}, {02, 6}, {02, 5}, {02, 4}, {06, 4}, {03, 0}, {04, 7}, {01, 5}
			},
			{
				{01, 4}, {01, 3}, {01, 2}, {01, 0}, {01, 1}, {00, 4}, {00, 7}, {00, 6}
			},
			{
				{05, 0}, {05, 1}, {05, 2}, {05, 3}, {05, 4}, {06, 3}, {06, 2}, {06, 1}
			},
			{
				{04, 1}, {04, 0}, {07, 7}, {8, 2}, {8, 1}, {07, 1}, {07, 0}, {06, 7}
			},
			{
				{06, 0}, {9, 5}, {9, 4}, {9, 1}, {9, 0}, {04, 6}, {04, 5}, {04, 4}
			},
			{
				{8, 4}, {8, 3}, {8, 0}, {06, 5}, {06, 6}, {07, 6}, {00, 1}, {03, 1}
			},
			{
				{07, 5}, {07, 4}, {03, 5}, {8, 7}, {11, 7}, {8, 6}, {10, 7}, {9, 6}
			},
			{
				{11, 3}, {11, 2}, {11, 1}, {11, 5}, {11, 0}, {10, 2}, {10, 4}, {9, 7}
			},
			{
				{10, 6}, {10, 5}, {10, 1}, {11, 4}, {10, 0}, {11, 6}, {10, 3}, {00, 0}
			}
		}
	}
};

//******** Function Prototypes *******
static BOOL applyScrambling(UINT8PTR inputData, UINT8PTR outBuffer , UINT8 scrMethodNum);
static BOOL applyUnScrambling(UINT8PTR inputData, UINT8PTR outBuffer, UINT8 scrMethodNum);
static void ByteScrambling(UINT8PTR inData, UINT8PTR outData, BOOL mode);
static VOID getScramblingMethod(UINT8 methodNum, SCRAMBLE_METHOD_t * pScramblingMethod);
static VOIDPTR ResolveLicenceDongleThreadFunc(VOIDPTR dummy);
//******** Function Definations ******

//*****************************************************************************
//	InitLicenseDongleState()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function runs ACMS File Transfer task
//
//*****************************************************************************
void InitLicenseDongleState(void)
{
	licenseDongleMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
	LicensePollDuration = DEFAULT_LICENSE_POLL_DURATION;
	licensePollInterval = DEFAULT_LICENSE_POLL_INTERVAL;
	LicenseServerConnctnStatus = ACMS_OFFLINE;
	LicenseDongleIpResolver();
}

//*****************************************************************************
//	GetLicenseConnctionServerStatus()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function runs ACMS File Transfer task
//
//*****************************************************************************
ACMS_COMM_STATUS_e GetLicenseConnctionServerStatus(void)
{
 	return LicenseServerConnctnStatus;
}

//*****************************************************************************
//	RunAcmsFtcTask()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function runs ACMS File Transfer task
//
//*****************************************************************************
void RunLicenseDongleTask(void)
{
	BOOL	rxTxStatus;
	UINT8	finalEncrpData[17]={0}, idCode[17] = {0}, idx, tmpIdCode[33];
	CHARPTR	licenseDongleRecvPtr;
	UINT64	parseField[4];
	UINT16	length;
	CHAR	acmsMsgSendBuf[MAX_ACMS_PACKET_SZ], licenseKey[LICENSE_KEY_SIZE + 1], oldLicenseKey[LICENSE_KEY_SIZE + 1], serialNumber[9], mac[21], aup[9], licenseInfo[195],tempReadBuff[LICENSE_KEY_SIZE + 1];
	UINT32  tmpLngth = 0, hId = 0;
	UINT8	readmac[20],tempwritingLicenseBuffer[21];

	if( (LicenseDongleConntedPrevState == LicenseDongleConnted) || (stopConnectionCount >= 12) )
	{
		return;
	}

	if( LicenseServerConnctnStatus == ACMS_OFFLINE )
	{
		LicenseDongleIpResolver();
	}
	switch(licenseDongleMsgState)
	{
	default:
		case LICENSE_DONGLE_SEND_LICENSE_CHK_REQ:
		{
			CreateIdentityCode(finalEncrpData);

			tmpLngth = sprintf(acmsMsgSendBuf, "%c%s%c%d%c%s%c",
						SOT, licenseDongleSendMsgHdr[REQ_LICNSE_KEY], FSP, LicenseDongleConnted , FSP,
							EthernetParameters.macAddress, FSP);

			for(idx = 0; idx < 16; idx++)
			{
				tmpLngth += sprintf(&acmsMsgSendBuf[tmpLngth], "%02x", finalEncrpData[idx]);
			}
			sprintf(&acmsMsgSendBuf[tmpLngth] ,"%c%c",FSP, EOT);

			// Send ACMS Message
			SendAcmsData(LICENSE_SERVER_SOCKET, acmsMsgSendBuf, strlen(acmsMsgSendBuf));

			licenseDongleMsgWaitTime = CONVERT_SEC_TO_MSEC(LicensePollDuration);
			licenseDongleNxtMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
			licenseDongleNxtMsgSuccessState = LICENSE_DONGLE_ACK_LICENSE_CHK;
			licenseDongleMsgState = LICENSE_DONGLE_SEND_MSG_WAIT_STATE;

			DPRINT(ACMS_LOG, "Send License Dongle Request LCK Message --> %s", acmsMsgSendBuf);
			break;
		}

		case LICENSE_DONGLE_ACK_LICENSE_CHK:
		{
			rxTxStatus = RecvAcmsData(LICENSE_SERVER_SOCKET, &licenseDongleRecvPtr, &length);
			if(rxTxStatus == SUCCESS)
			{
				if(GetRecvMsgHeader(licenseDongleSendMsgHdr, MAX_LICENSE_DONGLE_SND_MSG_HDR, &licenseDongleRecvPtr) == ACK_LICNSE_KEY)
				{
					DPRINT(ACMS_LOG, "Send License Dongle Request LCK ACK Received ");
					//this case will come when user deregister and change url or port then
					//with new url or port if dongle will come online with server then increase lockCount
					LicenseServerConnctnStatus = ACMS_ONLINE;

					if(GetDataParseField(&licenseDongleRecvPtr, parseField, 1) == SUCCESS)
					{
						licenseDnglRspCode = (LICENSE_DONGLE_RESPONSE_CODE_e)parseField[0];
					}

					ParseString(&licenseDongleRecvPtr, (CHARPTR)tmpIdCode, sizeof(tmpIdCode));

					ConvertStringToHexArray((char *)tmpIdCode, idCode, 16);
					if(VerifyIdentityCode(idCode) == FALSE)
					{
						licenseDongleMsgTimerTick = GetSysTick();
						licenseDongleMsgState = LICENSE_DONGLE_POLL_INTERVAL_STATE;
						return ;
					}

					if(LicenseDongleConnted == FALSE)
					{
						stopConnectionCount++;
					}

					licenseDongleMsgTimerTick = GetSysTick();

					//change state on the bases of response code
					if((licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_SUCCESS) ||
							(licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_FAIL))
					{
						if((licenseServerParaChangeF == TRUE) && (licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_SUCCESS))
						{
							licenseServerParaChangeF = FALSE;
							IncreaseLockCount();
						}

						if( (DongleInsertedF == TRUE) && (licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_SUCCESS) )
						{
							DongleInsertedF = FALSE;
							memset(readmac, 0, sizeof(readmac));
							ReadLicenseDongle(MAC_STARTING_ADDS, MAC_SIZE, (unsigned char *)readmac);
							if(ReadLockCountAndMacAddress(readmac, LICENSE_DONGLE_MAC_CHANGE) == TRUE)
							{
								snprintf((char *)tempwritingLicenseBuffer, sizeof(tempwritingLicenseBuffer), "%u|%s", LockCount, EthernetParameters.macAddress);
								WriteLicenseDongle(MAC_STARTING_ADDS, MAC_SIZE, (unsigned char *)tempwritingLicenseBuffer);
							}
						}

						licenseDongleMsgState = LICENSE_DONGLE_POLL_INTERVAL_STATE;
					}
					if(licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_WRITE_KEY)
					{
						licenseDongleMsgState = LICENSE_DONGLE_GET_LICENSE_KEY_REQ;
					}
					if(licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_READ_KEY)
					{
						licenseDongleMsgState = LICENSE_DONGLE_READ_LICENSE_KEY_REQ;
					}
					CloseClientSocket(LICENSE_SERVER_SOCKET);
				}
			}
			else if(ElapsedTick(licenseDongleMsgTimerTick) >= licenseDongleMsgWaitTime)
			{
				licenseDongleMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
				CloseClientSocket(LICENSE_SERVER_SOCKET);
				LicenseServerConnctnStatus = ACMS_OFFLINE;
			}
			break;
		}

		case LICENSE_DONGLE_GET_LICENSE_KEY_REQ:
		{
			tmpLngth =0;
			CreateIdentityCode(finalEncrpData);

			tmpLngth = sprintf(acmsMsgSendBuf, "%c%s%c%s%c",
								SOT, licenseDongleSendMsgHdr[GET_LICNSE_KEY], FSP, EthernetParameters.macAddress,
								 FSP);

			for(idx = 0; idx < 16; idx++)
			{
				tmpLngth += sprintf(&acmsMsgSendBuf[tmpLngth], "%02x", finalEncrpData[idx]);
			}
			sprintf(&acmsMsgSendBuf[tmpLngth] ,"%c%c",FSP, EOT);

			// Send ACMS Message
			SendAcmsData(LICENSE_SERVER_SOCKET, acmsMsgSendBuf, strlen(acmsMsgSendBuf));

			licenseDongleMsgWaitTime = CONVERT_SEC_TO_MSEC(LicensePollDuration);
			licenseDongleNxtMsgState = LICENSE_DONGLE_GET_LICENSE_KEY_REQ;
			licenseDongleNxtMsgSuccessState = LICENSE_DONGLE_GET_LICENSE_KEY_ACK;
			licenseDongleMsgState = LICENSE_DONGLE_SEND_MSG_WAIT_STATE;

			DPRINT(ACMS_LOG, "Send License Dongle GET LICENSE KEY Message --> %s", acmsMsgSendBuf);

			break;
		}

		case LICENSE_DONGLE_GET_LICENSE_KEY_ACK:
		{
			rxTxStatus = RecvAcmsData(LICENSE_SERVER_SOCKET, &licenseDongleRecvPtr, &length);
			if(rxTxStatus == SUCCESS)
			{
				memset(tmpIdCode, 0, sizeof(tmpIdCode));
				memset(&licenseKey, 0, sizeof(licenseKey));
				DPRINT(ACMS_LOG, "Send License Dongle GET LCK ACK Received ");

				if(GetRecvMsgHeader(licenseDongleSendMsgHdr, MAX_LICENSE_DONGLE_SND_MSG_HDR, &licenseDongleRecvPtr) == ACK_GET_LICNSE_KEY)
				{
					if(GetDataParseField(&licenseDongleRecvPtr, parseField, 1) == SUCCESS)
					{
						licenseDnglRspCode = (LICENSE_DONGLE_RESPONSE_CODE_e)parseField[0];
					}

					ParseString(&licenseDongleRecvPtr, licenseKey, sizeof(licenseKey));
					ParseString(&licenseDongleRecvPtr, oldLicenseKey, sizeof(oldLicenseKey));
					ParseString(&licenseDongleRecvPtr, (CHARPTR)tmpIdCode, sizeof(tmpIdCode));

					ConvertStringToHexArray((char *)tmpIdCode, idCode, 16);

					if(VerifyIdentityCode(idCode) == FALSE)
					{
						licenseDongleMsgTimerTick = GetSysTick();
						licenseDongleMsgState = LICENSE_DONGLE_POLL_INTERVAL_STATE;
						return ;
					}

					licenseDongleMsgTimerTick = GetSysTick();
					//change state on the bases of response code
					if(licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_FAIL)
					{
						licenseDongleMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
					}
					else
					{
						memset(tempReadBuff, 0, sizeof(tempReadBuff));
						ReadLicenseDongle(DONGLE_KEY_STARTING_ADDRS, LICENSE_KEY_SIZE, (unsigned char *)tempReadBuff);
						if(strcmp(tempReadBuff, oldLicenseKey) == 0)
						{
							DPRINT(ACMS_LOG,"Old-licence and current license key matched\n");
							WriteLicenseDongle(DONGLE_KEY_STARTING_ADDRS, LICENSE_KEY_SIZE, (unsigned char *)licenseKey);
						}
						licenseDongleMsgState = LICENSE_DONGLE_READ_LICENSE_KEY_REQ;
					}
				}
				CloseClientSocket(LICENSE_SERVER_SOCKET);
			}
			else if(ElapsedTick(licenseDongleMsgTimerTick) >= licenseDongleMsgWaitTime)
			{
				licenseDongleMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
				CloseClientSocket(LICENSE_SERVER_SOCKET);
				LicenseServerConnctnStatus = ACMS_OFFLINE;
			}
			break;
		}

		case LICENSE_DONGLE_READ_LICENSE_KEY_REQ:
		{
			tmpLngth = 0;
			if(LicenseDongleConnted == FALSE)
			{
				licenseDongleMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
				CloseClientSocket(LICENSE_SERVER_SOCKET);
			}
			memset(&licenseKey,0,sizeof(licenseKey));
			memset(&serialNumber,0,sizeof(serialNumber));
			memset(&mac,0,sizeof(mac));
			memset(&aup,0,sizeof(aup));

			CreateIdentityCode(finalEncrpData);

			if(ReadLicenseDongle(DONGLE_KEY_STARTING_ADDRS, LICENSE_KEY_SIZE, (unsigned char *)licenseKey) == TRUE)
			{

				ReadLicenseDongle(SERIAL_NO_STARTING_ADDRS, DONGLE_SERIAL_NO_SIZE, (unsigned char *)serialNumber);
				ReadLicenseDongle(MAC_STARTING_ADDS, MAC_SIZE, (unsigned char *)mac);
				ReadLicenseDongle(AUP_STARTING_ADDS, AUP_SIZE, (unsigned char *)aup);

				GetDongleHardwareId(&hId);
				sprintf(licenseInfo,"%s#%s# #%s#%d", serialNumber, licenseKey, aup, hId);

				//this is only when we read only lock count
				ReadLockCountAndMacAddress((UINT8PTR)mac, MAX_LICENSE_DONGLE_CHANGE_PARA);
				if(LockCount >= 20)
				{
					ReadStatus = 0;
				}
				else
				{
					ReadStatus = 1;
				}

				tmpLngth = sprintf(acmsMsgSendBuf, "%c%s%c%d%c%s%c%s%c",
							SOT, licenseDongleSendMsgHdr[REQ_READ_KEY], FSP, ReadStatus, FSP,
								EthernetParameters.macAddress, FSP, licenseInfo, FSP);

				for(idx = 0; idx < 16; idx++)
				{
					tmpLngth += sprintf(&acmsMsgSendBuf[tmpLngth], "%02x", finalEncrpData[idx]);
				}
				sprintf(&acmsMsgSendBuf[tmpLngth] ,"%c%c",FSP, EOT);

				DPRINT(ACMS_LOG, "Send License Dongle SET LICENSE KEY Message --> %s", acmsMsgSendBuf);
			}
			else
			{
				// if we fail to read license key then send
				//license key=""
				//serialNumber = ""
				//mac = ""
				//aup = ""
				ReadStatus = 0;
				memset(&licenseKey,0,sizeof(licenseKey));

				sprintf(licenseInfo,"%s#%s# #%s",serialNumber, licenseKey, aup);

				tmpLngth = sprintf(acmsMsgSendBuf, "%c%s%c%d%c%s%c%s%c",
												SOT, licenseDongleSendMsgHdr[REQ_READ_KEY], FSP, ReadStatus, FSP,
												 EthernetParameters.macAddress, FSP, licenseInfo, FSP);

				for(idx = 0; idx < 16; idx++)
				{
					tmpLngth += sprintf(&acmsMsgSendBuf[tmpLngth], "%02x", finalEncrpData[idx]);
				}
				sprintf(&acmsMsgSendBuf[tmpLngth] ,"%c%c",FSP, EOT);

				DPRINT(ACMS_LOG, "Send License Dongle SET LICENSE KEY Message --> %s", acmsMsgSendBuf);
			}
			// Send ACMS Message
			SendAcmsData(LICENSE_SERVER_SOCKET, acmsMsgSendBuf, strlen(acmsMsgSendBuf));

			licenseDongleMsgWaitTime = CONVERT_SEC_TO_MSEC(LicensePollDuration);
			licenseDongleNxtMsgState = LICENSE_DONGLE_READ_LICENSE_KEY_REQ;
			licenseDongleNxtMsgSuccessState = LICENSE_DONGLE_READ_LICENSE_KEY_ACK;
			licenseDongleMsgState = LICENSE_DONGLE_SEND_MSG_WAIT_STATE;

			break;
		}

		case LICENSE_DONGLE_READ_LICENSE_KEY_ACK:
		{
			rxTxStatus = RecvAcmsData(LICENSE_SERVER_SOCKET, &licenseDongleRecvPtr, &length);
			if(rxTxStatus == SUCCESS)
			{
				memset(aup, 0, sizeof(aup));
				memset(tmpIdCode, 0, sizeof(tmpIdCode));

				DPRINT(ACMS_LOG, "Send License Dongle SET LCK ACK Received ");
				if(GetRecvMsgHeader(licenseDongleSendMsgHdr, MAX_LICENSE_DONGLE_SND_MSG_HDR, &licenseDongleRecvPtr) == ACK_READ_KEY)
				{
					if(GetDataParseField(&licenseDongleRecvPtr, parseField, 1) == SUCCESS)
					{
						licenseDnglRspCode = (LICENSE_DONGLE_RESPONSE_CODE_e)parseField[0];
					}

					ParseString(&licenseDongleRecvPtr, aup, sizeof(aup));

					ParseString(&licenseDongleRecvPtr, (CHARPTR)tmpIdCode, sizeof(tmpIdCode));
					ConvertStringToHexArray((char *)tmpIdCode, idCode, 16);

					if(VerifyIdentityCode(idCode) == FALSE)
					{
						DPRINT(ACMS_LOG,"Verify identity code mismatch \n");
						licenseDongleMsgTimerTick = GetSysTick();
						licenseDongleMsgState = LICENSE_DONGLE_POLL_INTERVAL_STATE;
						return ;
					}

					licenseDongleMsgTimerTick = GetSysTick();
					//if response code is success or fail
					if((licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_SUCCESS) ||
											(licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_FAIL))
					{
						licenseDongleMsgState = LICENSE_DONGLE_POLL_INTERVAL_STATE;
					}
					else if(licenseDnglRspCode == LICENSE_DONGLE_RESPONSE_CODE_WRITE_KEY)
					{
						WriteLicenseDongle(AUP_STARTING_ADDS, AUP_SIZE, (unsigned char *)aup);
						licenseDongleMsgState = LICENSE_DONGLE_READ_LICENSE_KEY_REQ;
					}
				}
				CloseClientSocket(LICENSE_SERVER_SOCKET);
			}
			else if(ElapsedTick(licenseDongleMsgTimerTick) >= licenseDongleMsgWaitTime)
			{
				licenseDongleMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
				CloseClientSocket(LICENSE_SERVER_SOCKET);
				LicenseServerConnctnStatus = ACMS_OFFLINE;
			}
			break;
		}

		case LICENSE_DONGLE_POLL_INTERVAL_STATE:
		{
			if(ElapsedTick(licenseDongleMsgTimerTick) >= CONVERT_SEC_TO_MSEC(licensePollInterval))
			{
				licenseDongleMsgState = LICENSE_DONGLE_SEND_LICENSE_CHK_REQ;
				CloseClientSocket(LICENSE_SERVER_SOCKET);
			}
			break;
		}

		case LICENSE_DONGLE_SEND_MSG_WAIT_STATE:
		{
			rxTxStatus = GetAcmsTxStatus(LICENSE_SERVER_SOCKET);
			if(rxTxStatus == SUCCESS)
			{
				licenseDongleMsgWaitTime = CONVERT_SEC_TO_MSEC(LicensePollDuration);
				licenseDongleMsgTimerTick = GetSysTick();
				licenseDongleMsgState = licenseDongleNxtMsgSuccessState;
			}
			else if(rxTxStatus == FAIL)
			{
				LicenseDongleIpResolver();
				licenseDongleMsgState = LICENSE_DONGLE_SEND_RECV_MSG_WAIT_STATE;
				licenseDongleMsgTimerTick = GetSysTick();
			}
			break;
		}

		case LICENSE_DONGLE_SEND_RECV_MSG_WAIT_STATE:
		{
			if(ElapsedTick(licenseDongleMsgTimerTick) >= licenseDongleMsgWaitTime)
			{
				licenseDongleMsgState = licenseDongleNxtMsgState;
				LicenseServerConnctnStatus = ACMS_OFFLINE;
			}
			break;
		}

	}
}

//*****************************************************************************
//	WriteMacIpInfoOfLockCountInDongle()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function Writes MAC and IP of device in Dongle when LockCount increases
//
//*****************************************************************************
VOID WriteMacIpInfoOfLockCountInDongle(VOID)
{
	UINT16	offset;
	UINT8	temp, writeBuff[5]={0};

	offset = 2000 - LockCount*4;

	ConvAsciiCharToHexChar(&EthernetParameters.macAddress[12], &temp);
	writeBuff[0] = temp << 4;
	ConvAsciiCharToHexChar(&EthernetParameters.macAddress[13], &temp);
	writeBuff[0] |= temp;

	ConvAsciiCharToHexChar(&EthernetParameters.macAddress[15], &temp);
	writeBuff[1] = temp << 4;
	ConvAsciiCharToHexChar(&EthernetParameters.macAddress[16], &temp);
	writeBuff[1] |= temp;

	writeBuff[2] = atoi(&LicenseDongleCfg.licenseServerIpAddress[8]);
	writeBuff[3] = atoi(&LicenseDongleCfg.licenseServerIpAddress[12]);

	EPRINT(ACMS_LOG, "%x, %x, %u, %u", writeBuff[0], writeBuff[1], writeBuff[2], writeBuff[3]);

	WriteLicenseDongle(offset, 4, (unsigned char *)writeBuff);
}

//*****************************************************************************
//	ReadMacIpInfoOfLockCountFromDongle()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function reads MAC and IP from Dongle of each LockCount
//
//*****************************************************************************
VOID ReadMacIpInfoOfLockCountFromDongle(VOID)
{
	UINT16	offset;
	UINT8	count, readBuffer[81]={0};
	INT32 	startReadingAddrs=1920;

	ReadLicenseDongle(startReadingAddrs, 80, (unsigned char*)readBuffer);

	for(count = 1; count <= 20; count++)
	{
		offset = 80 - count*4;
		DPRINT(DC_LOG, "Lock count: %u, MAC: %02x:%02x, IP: %u.%u", count, readBuffer[offset], readBuffer[offset+1], readBuffer[offset+2], readBuffer[offset+3]);
	}
}

//*****************************************************************************
//	ReadLockCountAndMacAddress()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function Read lock count and MAc address from License dongle.
//
//*****************************************************************************
UINT8 ReadLockCountAndMacAddress(UINT8PTR buffer, CHANGE_PARA_e changePara)
{
	CHAR		tempbuff[MAX_MAC_ADDRESS];
	UINT8PTR	enPtr;

	if(LicenseDongleConnted == TRUE)
	{
		enPtr = (UINT8PTR)strchr((const char *)buffer, '|');
		if(enPtr == NULL)
		{
			return FALSE;
		}

		*enPtr = '\0';
		LockCount = (UINT8)atoi((const char *)buffer);

		enPtr++;
		memcpy(tempbuff, enPtr, MAX_MAC_ADDRESS);

		DPRINT(ACMS_LOG, "LockCount [%d] , MAC: %s\n", LockCount, tempbuff);
		if(changePara == LICENSE_DONGLE_URL_AND_PORT_CHANGE)
		{
			if(LockCount >= 20)
			{
				EPRINT(ACMS_LOG, "LOCK Count : %d \n", LockCount);
				LockCount = 20;
			}
			else
			{
				LockCount++;
				WriteMacIpInfoOfLockCountInDongle();
				EPRINT(ACMS_LOG,"LockCount change due to License Server URL or Port change [%d]\n",LockCount);
				return TRUE;
			}
		}
		else if(changePara == LICENSE_DONGLE_MAC_CHANGE)		//LICENSE_DONGLE_MAC_CHANGE
		{
			if(memcmp(tempbuff, EthernetParameters.macAddress, MAX_MAC_ADDRESS-1) != 0)
			{
				if(LockCount >= 20)
				{
					EPRINT(ACMS_LOG,"LOCK Count : %d \n",LockCount);
					LockCount = 20;
				}
				else
				{
					LockCount++;
					WriteMacIpInfoOfLockCountInDongle();
					EPRINT(ACMS_LOG,"LockCount increase due to mac change [%d]\n",LockCount);
					return TRUE;
				}
			}
			else
			{
				return FALSE;
			}
		}
		else
		{
			//this case will come only if we want lockCount only
			return FALSE;
		}
	}
	return FALSE;
}

//*****************************************************************************
//	IncreaseLockCount()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function Read lock count and increase.
//
//*****************************************************************************
void IncreaseLockCount(void)
{
	UINT8 mac[20], tempwritingLicenseBuffer[21];

	ReadLicenseDongle(MAC_STARTING_ADDS, MAC_SIZE, (unsigned char *)mac);
	if(ReadLockCountAndMacAddress(mac, LICENSE_DONGLE_URL_AND_PORT_CHANGE) == TRUE)
	{
		snprintf((char *)tempwritingLicenseBuffer, sizeof(tempwritingLicenseBuffer), "%u|%s", LockCount, EthernetParameters.macAddress);
		WriteLicenseDongle(MAC_STARTING_ADDS, MAC_SIZE, (unsigned char *)tempwritingLicenseBuffer);
	}
}

//*****************************************************************************
//	CreateIdentityCode()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function create final encrpt data.
//
//*****************************************************************************
VOID CreateIdentityCode(UINT8PTR finalEncrpData)
{
	UINT8	identityCode[13] = "VYM", randBytesBuff[5], outByteScrmblngData[13], outBitScrmblngBuffer[16]={0};
	UINT8	methodNo=0, iv[32] = {0};
	UINT8	key[32] = {0x73, 0x65, 0x65, 0x20, 0x50, 0x4f, 0x53, 0x49, 0x58, 0x2e, 0x31, 0x2d, 0x32, 0x30, 0x30, 0x38, 0x20, 0x52, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x61, 0x6c, 0x65, 0x20, 0x41, 0x2e, 0x34, 0x2e, 0x31};
	UINT32 	tempMethodNo, randNum;

	//generate random number
	randNum = random();

	tempMethodNo = GetSysTick();
	methodNo = (UINT8)tempMethodNo%32;

	identityCode[3] = methodNo;

	snprintf((char *)randBytesBuff, sizeof(randBytesBuff), "%u", randNum);

	memcpy(&identityCode[4], randBytesBuff, 4);
	lastRandBytes = atoi((const char *)randBytesBuff);

	DPRINT(ACMS_LOG,"MethodNo[%d], randnum: %u\n", methodNo, lastRandBytes);

	if(licenseServerParaChangeF == TRUE)
	{
		LastServerRandom = 0;
	}

	sprintf((char *)identityCode+8, "%04u", LastServerRandom);
	//byte Scrambling
	ByteScrambling(identityCode, outByteScrmblngData, BYTE_SCREMBALING_FWD);
	//apply bit scrambling
	applyScrambling(outByteScrmblngData ,outBitScrmblngBuffer, methodNo);

	memset(iv, 0, 32);
	AesCbc256EncryptData(outBitScrmblngBuffer, finalEncrpData, sizeof(outBitScrmblngBuffer), key, iv, AES_ENCRYPT);
}

//*****************************************************************************
//	VerifyIdentityCode()
//	Param:
//		IN:		None
//		OUT: 	None
//	Returns:
//				None
//	Description:
//			This function Decrpt data coming from license server.
//
//*****************************************************************************
BOOL VerifyIdentityCode(UINT8PTR encData)
{
	UINT8 outByteScrmblngData[13]={0}, outBitScrmblngBuffer[12]={0}, decryptedData[16]={0},tmpRandbuff[5], tmpAcmsRandbuff[5];
	UINT8 iv[32] = {0};
	UINT8 key[32] = {0x73, 0x65, 0x65, 0x20, 0x50, 0x4f, 0x53, 0x49, 0x58, 0x2e, 0x31, 0x2d, 0x32, 0x30, 0x30, 0x38, 0x20, 0x52, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x61, 0x6c, 0x65, 0x20, 0x41, 0x2e, 0x34, 0x2e, 0x31};

	memset(iv, 0, 32);
	AesCbc256EncryptData(encData, decryptedData, sizeof(decryptedData), key, iv, AES_DECRYPT);

	//apply bit unscrambling
	applyUnScrambling(decryptedData, outBitScrmblngBuffer, decryptedData[5] & 0x1F);

	//byte UnScrambling
	ByteScrambling(outBitScrmblngBuffer, outByteScrmblngData, BYTE_SCREMBALING_BKWD);

	if(memcmp(outByteScrmblngData, "VYM", 3) == 0)
	{
		tmpRandbuff[4] = '\0';
		memcpy(tmpRandbuff, &outByteScrmblngData[4], 4);

		DPRINT(ACMS_LOG, "data: %s ", outByteScrmblngData+4);
		DPRINT(ACMS_LOG, "tmpRandbuff: %u, lastRandBytes: %u", atoi((const char *)tmpRandbuff), lastRandBytes );

		if((UINT16)atoi((const char *)tmpRandbuff) == lastRandBytes)
		{
			DPRINT(ACMS_LOG, "Last saved device random number and received device random number matches\n");
			tmpAcmsRandbuff[4] = '\0';
		    memcpy(tmpAcmsRandbuff, &outByteScrmblngData[8], 4);

			if((UINT16)atoi((const char *)tmpAcmsRandbuff) != LastServerRandom)
			{
				LastServerRandom = (UINT16)atoi((const char *)tmpAcmsRandbuff);
				DPRINT(ACMS_LOG, " Updated ServerRandom number: %u " , LastServerRandom );
				return TRUE;
			}
		}
	}
	return FALSE;
}

//*****************************************************************************
//	applyScrambling()
//	Param:
//		IN :	UINT8PTR 	scrabmedDigits
//		OUT: 	UINT8PTR 	profileBuf
//	Returns:
//		SUCCESS/FAIL
//	Description:
// 		This function apply unscrambling method as define in scrambleDigits by
//		extracting 5 bits as per sad.
//*****************************************************************************
static BOOL applyScrambling(UINT8PTR inputData, UINT8PTR outBuffer, UINT8 scrMethodNum)
{
//	UINT8 scrMethodNum = 0;
	SCRAMBLE_METHOD_t scramblMethod;

	UINT8 	methodByteNum = 0;
	UINT8 	methodBitNum = 0;
	UINT16	byteCnt = 0;
	UINT8	bitCnt = 0;
	BOOL 	scrambledBit = 0;

	// method num must in between 0 -- 31
	if (scrMethodNum >= MAX_SCRAMBLING_METHOD)
	{
		return FALSE;
	}

	// Get scrabling method
	getScramblingMethod(scrMethodNum, &scramblMethod);

	memset(outBuffer, 0, sizeof(UINT8) * MAX_SERVICE_PROFILE_LEN);

	// service profile array value
	for (byteCnt = 0; byteCnt < MAX_SERVICE_PROFILE_LEN; byteCnt++)
	{
		for (bitCnt = 0; bitCnt < BITS_PER_BYTE; bitCnt++)
		{
			// Get method byte num and bit num
			methodByteNum = scramblMethod.methodPara[byteCnt][bitCnt].methodByte;
			methodBitNum = scramblMethod.methodPara[byteCnt][bitCnt].methodBit;

			// Get scrambled bit
			scrambledBit = 0;
			scrambledBit = (inputData[byteCnt] >> bitCnt) & 0x01;

			// Put scrambled bit, proper position
			outBuffer[methodByteNum] |= scrambledBit << methodBitNum;
		}
	}
	return TRUE;
}

//*****************************************************************************
//	applyUnScrambling()
//	Param:
//		IN :	UINT8PTR 	scrabmedDigits
//		OUT: 	UINT8PTR 	profileBuf
//	Returns:
//		SUCCESS/FAIL
//	Description:
// 		This function apply unscrambling method as define in scrambleDigits by
//		extracting 5 bits as per sad.
//*****************************************************************************
static BOOL applyUnScrambling(UINT8PTR inputData, UINT8PTR outBuffer, UINT8 scrMethodNum)
{
	SCRAMBLE_METHOD_t scramblMethod;
	UINT8 	methodByteNum = 0;
	UINT8 	methodBitNum = 0;
	UINT16	byteCnt = 0;
	UINT8	bitCnt = 0;
	BOOL 	scrambledBit = 0;

	// method num must in between 0 -- 31
	if (scrMethodNum >= MAX_SCRAMBLING_METHOD)
	{
		EPRINT(ACMS_LOG, "Un Scrambling method invalid :%d", scrMethodNum);
		return FALSE;
	}

	// Get scrambling method
	getScramblingMethod(scrMethodNum, &scramblMethod);

	for (byteCnt = 0; byteCnt < MAX_SERVICE_PROFILE_LEN; byteCnt++)
	{
		for (bitCnt = 0; bitCnt < BITS_PER_BYTE; bitCnt++)
		{
			// Get method byte num and bit num
			methodByteNum = scramblMethod.methodPara[byteCnt][bitCnt].methodByte;
			methodBitNum = scramblMethod.methodPara[byteCnt][bitCnt].methodBit;

			// Get scrambled bit
			scrambledBit = 0;
			scrambledBit = (inputData[methodByteNum] >> methodBitNum) & 0x01;

			// Put scrambled bit, proper position
			outBuffer[byteCnt] = outBuffer[byteCnt] |
									((scrambledBit & 0x01) << bitCnt);
		}
	}
	return TRUE;
}

//*****************************************************************************
//	ByteScrambling()
//	Param:
//		IN :	UINT8PTR 	inData,outData
//		IN :	BOOL		byteScramblling Mode
//		OUT: 	UINT8PTR 	profileBuf
//	Returns:
//		SUCCESS/FAIL
//	Description: give scrambled byte according to byteScramblingTable table.
//
//*****************************************************************************
void ByteScrambling(UINT8PTR inData, UINT8PTR outData, BOOL mode)
{
	UINT8 i;
	UINT8 byteScramblingTable[] = {7, 5, 1, 6, 2, 4, 11, 3, 12, 8, 9, 10};

	if(mode == BYTE_SCREMBALING_FWD)
	{
		for(i=0; i<sizeof(byteScramblingTable); i++)
		{
			outData[i] = inData[byteScramblingTable[i]-1];
		}
	}
	else		//BYTE_SCREMBALING_BKWD
	{
		for(i=0; i<sizeof(byteScramblingTable); i++)
		{
			outData[byteScramblingTable[i]-1] = inData[i];
		}
	}

}
//*****************************************************************************
//	getScramblingMethod()
//	Param:
//		IN :	UINT8 		methodNum
//		OUT: 	SCRAMBLE_METHOD_t *pScramblingMethod
//	Returns:
//		SUCCESS/FAIL
//	Description:
// 		This function copy data of how to (un)scramble data as per define in SAD
//		document from method Number. There were 32 methods to (un)scramble data.
//*****************************************************************************
static VOID getScramblingMethod(UINT8 methodNum, SCRAMBLE_METHOD_t * pScramblingMethod)
{
	memcpy((VOIDPTR)pScramblingMethod, (VOIDPTR)&scramblingMethod[methodNum], sizeof(SCRAMBLE_METHOD_t));
}
//*****************************************************************************
//	ResolveAcmsIpAddrThreadFunc()
//	Param:
//		IN	:	NONE
//		OUT	:	NONE
//	Returns :	NONE
//	Description:
//		This function resolve ip address from host name. If host have more than one
//			Ip address then it will give link list of ip address. this function actualy
//			returns the addrinfo structure which contains all the necessary information
//			regarding socket.
//		This function called by thread at TxSocketDataHandler.
//*****************************************************************************
static VOIDPTR ResolveLicenceDongleThreadFunc(__attribute__((unused)) VOIDPTR dummy)
{
	struct addrinfo		*licenceDongleIpAddrInfo;
	struct addrinfo		hints;
	CHAR				licenceDonglePortString[6];
	CHAR				resolvedIpAddress[MAX_IP_ADDRESS];
	BOOL 				changeReqF = FALSE;

	memset(&hints, 0, sizeof(hints));
	hints.ai_family = AF_INET;
	hints.ai_socktype = SOCK_STREAM;

	// lock the node, in order to prevent multiple simultaneous access
	pthread_mutex_lock(&licenceDongleIpResolveMutex);

	if(strlen(LicenseDongleCfg.licenseServerUrl) == 0)
	{
		resolveLicenceDongleStatus = -1;
		pthread_mutex_unlock(&licenceDongleIpResolveMutex );
		resolveLicenceDongleThreadStatus = THREAD_INACTIVE;
		pthread_exit(NULL);
		return 0;
	}

	sprintf(licenceDonglePortString, "%d", LicenseDongleCfg.licenseServerPort);
	resolveLicenceDongleStatus = getaddrinfo(LicenseDongleCfg.licenseServerUrl,
										 licenceDonglePortString, &hints, &licenceDongleIpAddrInfo);

	if(resolveLicenceDongleStatus != 0)
	{
		EPRINT(SYS_LOG,"Fail to Resolve LicenceDongle IP Address: error: [%s]", gai_strerror(resolveLicenceDongleStatus));
	}
	else
	{
		memcpy(&resolvedIpSinAddr, &((struct sockaddr_in *) licenceDongleIpAddrInfo->ai_addr)->sin_addr, sizeof(struct in_addr));
		freeaddrinfo(licenceDongleIpAddrInfo);
	}

	if(resolveLicenceDongleStatus == 0)
	{
		memset(resolvedIpAddress, 0, sizeof(resolvedIpAddress));
		inet_ntop(AF_INET, &resolvedIpSinAddr, resolvedIpAddress, sizeof(resolvedIpAddress) );
		// If resolved ip address is diffrent then save into config structure
		if(strcmp(resolvedIpAddress, LicenseDongleCfg.licenseServerIpAddress) != 0)
		{
			snprintf(LicenseDongleCfg.licenseServerIpAddress ,sizeof(LicenseDongleCfg.licenseServerIpAddress) ,"%s",resolvedIpAddress);
			DPRINT(SYS_LOG, "Licence Dongle's resolved IP address [%s]",LicenseDongleCfg.licenseServerIpAddress );
			changeReqF = TRUE;
		}
	}

	if(changeReqF == TRUE)
	{
		if(WriteLicenseDongleConfig() == FAIL)
		{
			EPRINT(SYS_LOG, "Failed to save resolved Licence Dongle ip into configuration");
		}
	}

	resolveLicenceDongleThreadStatus = THREAD_INACTIVE;
	// unlock the resource
	pthread_mutex_unlock(&licenceDongleIpResolveMutex );
	pthread_exit(NULL);
}
//*****************************************************************************
//	LicenseDongleIpResolver
//	Param:
//		IN :	NONE
//		OUT:	NONE
//	Returns:	NONE
//	Description:
//			.
//****************************************************************************
void LicenseDongleIpResolver(void)
{

	if(resolveLicenceDongleThreadStatus == THREAD_INACTIVE)
	{
		resolveLicenceDongleThreadStatus = THREAD_ACTIVE;
		if(pthread_create(&resolveLicenceDongleThreadId, NULL, ResolveLicenceDongleThreadFunc, NULL) == 0)
		{
			pthread_detach(resolveLicenceDongleThreadId);
		}
		else
		{
			resolveLicenceDongleThreadStatus = THREAD_INACTIVE;
		}
	}
}
